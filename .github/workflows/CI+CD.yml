name: CI/CD - Build, Push Docker, Deploy to EC2

on:
  push:
    branches:
      - prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ë ˆí¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      # 2. JDK ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      
      # 3. application.properties ìƒì„±
      - name: Create application.properties
        run: |
          mkdir -p src/main/resources
          echo "${{ secrets.APPLICATION_PROPERTIES }}" | base64 -d > src/main/resources/application.properties
          echo "âœ… application.properties created successfully"
      
      # 4. Maven ë¹Œë“œ (QueryDSL Q í´ë˜ìŠ¤ ìƒì„± í¬í•¨)
      - name: Build with Maven (including QueryDSL)
        run: |
          echo "ğŸ”¨ Starting Maven build with QueryDSL generation..."
          mvn clean compile
          echo "âœ… Compile phase completed (Q classes generated)"
          mvn package -DskipTests
          echo "âœ… Package phase completed"
      
      # 5. ë¹Œë“œ ì‚°ì¶œë¬¼ ê²€ì¦
      - name: Verify Build Artifacts
        run: |
          echo "ğŸ“¦ Checking JAR file..."
          ls -lh target/*.jar
          echo ""
          echo "ğŸ“‚ Checking generated Q classes..."
          find target/generated-sources/annotations -name "Q*.java" 2>/dev/null | head -10 || echo "âš ï¸ No Q*.java found"
          echo ""
          echo "ğŸ” Checking Q classes in JAR..."
          jar tf target/*.jar | grep "Q.*\.class" | head -20 || echo "âš ï¸ Warning: No Q classes found in JAR"
      
      # 6. Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
      
      # 7. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          no-cache: true
          tags: |
            romaydev/meme:latest
            romaydev/meme:${{ github.sha }}
      
      # 8. EC2 ì„œë²„ ë°°í¬
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # EC2 ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p /home/ubuntu/logs
            
            # Docker ì´ë¯¸ì§€ ìµœì‹ í™”
            echo "ğŸ“¦ Pulling latest Docker image..."
            docker pull romaydev/meme:latest
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ/ì‚­ì œ
            echo "ğŸ”„ Stopping existing container..."
            docker stop meme || true
            docker rm meme || true
            
            # ë¯¸ì‚¬ìš© ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ§¹ Cleaning up unused images..."
            docker image prune -f
            
            # ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "â–¶ï¸ Starting new container..."
            docker run -d \
              --name meme \
              -p 8080:8080 \
              --network meme-network \
              --restart unless-stopped \
              -v /home/ubuntu/logs:/home/ubuntu/logs \
              romaydev/meme:latest
            
            # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
            echo "â³ Waiting for container to start..."
            sleep 10
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "âœ… Deployment completed!"
            docker ps | grep meme
            
            # í—¬ìŠ¤ì²´í¬ (ì„ íƒì‚¬í•­)
            echo "ğŸ¥ Health check..."
            curl -f http://localhost:8080/actuator/health || echo "âš ï¸ Health check endpoint not available"
