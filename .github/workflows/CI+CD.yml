name: CI/CD - Build, Push Docker, Deploy to EC2

on:
  push:
    branches:
      - prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ë ˆí¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      # 2. JDK ì„¤ì • (application.properties ìƒì„± ì „ì— ë¨¼ì € ì„¤ì •)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      
      # 3. application.properties ë””ì½”ë”©
      - name: Create application.properties
        run: |
          mkdir -p src/main/resources
          echo "${{ secrets.APPLICATION_PROPERTIES }}" | base64 -d > src/main/resources/application.properties
          echo "âœ… application.properties created successfully"
        shell: bash
      
      # 4. Maven ë¹Œë“œ
      - name: Build with Maven
        run: mvn clean package -DskipTests
      
      # 5. Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
      
      # 6. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            romaydev/meme:latest
            romaydev/meme:${{ github.sha }}
      
      # 7. EC2 ì„œë²„ì— SSH ì ‘ì† ë° Docker Pull & Run
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # Docker ì´ë¯¸ì§€ ìµœì‹ í™”
            echo "ğŸ“¦ Pulling latest Docker image..."
            docker pull romaydev/meme:latest
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ/ì‚­ì œ
            echo "ğŸ”„ Stopping existing container..."
            docker stop meme || true
            docker rm meme || true
            
            # ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "â–¶ï¸ Starting new container..."
            docker run -d \
              --name meme \
              -p 8080:8080 \
              --network meme-network \
              --restart unless-stopped \
              romaydev/meme:latest
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "âœ… Deployment completed!"
            docker ps | grep meme
