name: CI/CD - Build, Push Docker, Deploy to EC2

on:
  push:
    branches:
      - prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 레포 체크아웃
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      # 2. JDK 설정
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      
      # 3. application.properties 생성
      - name: Create application.properties
        run: |
          mkdir -p src/main/resources
          echo "${{ secrets.APPLICATION_PROPERTIES }}" | base64 -d > src/main/resources/application.properties
          echo "✅ application.properties created successfully"
      
      # 4. Maven 빌드 (QueryDSL Q 클래스 생성 포함)
      - name: Build with Maven (including QueryDSL)
        run: |
          echo "🔨 Starting Maven build with QueryDSL generation..."
          mvn clean compile
          echo "✅ Compile phase completed (Q classes generated)"
          mvn package -DskipTests
          echo "✅ Package phase completed"
      
      # 5. 빌드 산출물 검증
      - name: Verify Build Artifacts
        run: |
          echo "📦 Checking JAR file..."
          ls -lh target/*.jar
          echo ""
          echo "📂 Checking generated Q classes..."
          find target/generated-sources/annotations -name "Q*.java" 2>/dev/null | head -10 || echo "⚠️ No Q*.java found"
          echo ""
          echo "🔍 Checking Q classes in JAR..."
          jar tf target/*.jar | grep "Q.*\.class" | head -20 || echo "⚠️ Warning: No Q classes found in JAR"
      
      # 6. Docker Hub 로그인
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
      
      # 7. Docker 이미지 빌드 및 푸시
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          no-cache: true
          tags: |
            romaydev/meme:latest
            romaydev/meme:${{ github.sha }}
      
      # 8. EC2 서버 배포
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "🚀 Starting deployment..."
            
            # EC2 로그 디렉토리 생성
            mkdir -p /home/ubuntu/logs
            
            # Docker 이미지 최신화
            echo "📦 Pulling latest Docker image..."
            docker pull romaydev/meme:latest
            
            # 기존 컨테이너 종료/삭제
            echo "🔄 Stopping existing container..."
            docker stop meme || true
            docker rm meme || true
            
            # 미사용 이미지 정리
            echo "🧹 Cleaning up unused images..."
            docker image prune -f
            
            # 새로운 컨테이너 실행
            echo "▶️ Starting new container..."
            docker run -d \
              --name meme \
              -p 8080:8080 \
              --network meme-network \
              --restart unless-stopped \
              -v /home/ubuntu/logs:/home/ubuntu/logs \
              romaydev/meme:latest
            
            # 컨테이너 시작 대기
            echo "⏳ Waiting for container to start..."
            sleep 10
            
            # 컨테이너 상태 확인
            echo "✅ Deployment completed!"
            docker ps | grep meme
            
            # 헬스체크 (선택사항)
            echo "🏥 Health check..."
            curl -f http://localhost:8080/actuator/health || echo "⚠️ Health check endpoint not available"
